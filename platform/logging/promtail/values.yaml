# Promtail (single-node K3s / containerd friendly)
# - Tails /var/log/pods/*/*.log via Kubernetes SD + relabel to __path__
# - Pushes to Loki service inside the cluster
# - Mounts /var/log once (avoids duplicate mountPath errors)

config:
  enabled: true

  clients:
    - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push

  snippets:
    # Parse CRI containerd logs (K3s default)
    pipelineStages:
      - cri: {}

    # Minimal, correct scrape config for K8s pod logs on containerd
    scrapeConfigs: |
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod

        pipeline_stages:
          - cri: {}

        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node

          - action: replace
            source_labels: [__meta_kubernetes_namespace]
            target_label: namespace

          - action: replace
            source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

          - action: replace
            source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container

          # This is the key: point promtail to the actual pod log files on the node
          - action: replace
            separator: /
            source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            replacement: /var/log/pods/*$1/*.log
            target_label: __path__

# Run as DaemonSet (1 pod on your single node)
daemonset:
  enabled: true

# Mount /var/log from the node (contains /var/log/pods and /var/log/containers)
extraVolumes:
  - name: varlog
    hostPath:
      path: /var/log

extraVolumeMounts:
  - name: varlog
    mountPath: /var/log
    readOnly: true

rbac:
  create: true

serviceAccount:
  create: true

# Small resources for t3.small
resources:
  requests:
    cpu: 25m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 256Mi

# Optional: disable ServiceMonitor unless you want Prometheus scraping promtail
serviceMonitor:
  enabled: false

# Tolerate control-plane/master (common for single-node clusters)
tolerations:
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Exists"
    effect: "NoSchedule"
  - key: "node-role.kubernetes.io/master"
    operator: "Exists"
    effect: "NoSchedule"
