# Promtail - production-ish for K3s
# - DaemonSet
# - positions persistence ON (avoids re-sending logs)
# - ship pod logs to Loki service

daemonset:
  enabled: true

config:
  clients:
    - url: http://loki.monitoring.svc.cluster.local:3100/loki/api/v1/push

  positions:
    filename: /run/promtail/positions.yaml

  snippets:
    pipelineStages:
      - cri: {}

    scrapeConfigs: |
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod

        relabel_configs:
          - action: replace
            source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - action: replace
            source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
          - action: replace
            source_labels: [__meta_kubernetes_pod_container_name]
            target_label: container
          - action: replace
            source_labels: [__meta_kubernetes_pod_node_name]
            target_label: node

          # Standard CRI log path (K3s/containerd)
          - action: replace
            source_labels: [__meta_kubernetes_pod_uid, __meta_kubernetes_pod_container_name]
            separator: /
            target_label: __path__
            replacement: /var/log/pods/*$1/*.log

# IMPORTANT:
# Promtail chart already mounts common log paths.
# Avoid adding extraVolumeMounts to /var/log/pods or /var/lib/docker/containers (causes duplicate mountPath errors).

extraVolumes: []
extraVolumeMounts: []

# Persist positions (so restarts donâ€™t re-tail from start)
extraArgs:
  - -config.expand-env=true

extraEnv: []

podSecurityPolicy:
  enabled: false

rbac:
  create: true

serviceAccount:
  create: true

resources:
  requests:
    cpu: 25m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 256Mi

# Prometheus scrape (optional)
serviceMonitor:
  enabled: false

tolerations:
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Exists"
    effect: "NoSchedule"
  - key: "node-role.kubernetes.io/master"
    operator: "Exists"
    effect: "NoSchedule"

# Positions persistence using an emptyDir is ok, but PVC is better.
# The chart typically uses /run/promtail; if you want PVC, enable it like below if supported by your chart version:
# persistence:
#   enabled: true
#   size: 1Gi
